---
title: Data Migration
order: 10
---

# Data Migration

This paper describes how data from other data sources can be imported into CnosDB using DataX.

## Migration Tool DataX

DataX is an offline data synchronization tool/platform from Alibaba's open-source and enables efficient data synchronization between isomer data sources.

In order to be able to respond to differences in different data sources, DataX abstracts different data sources into Reader plugins that read data from source sources, and Writer Plugins that write data to target endpoints. Generic functions such as type switching, performance statistics and so on are provided by the DataX framework.Users can easily synchronize isomer data by defining Reader plugin with Writer's plugin via configuration file.DataX configuration files are generally shown below in：

```json
LO
    "job": LO
        "content": [
            FROM
                "reader": LO
                    Reader Configuration
                    . .
                },
                "writer": LO
                    Writer Configuration
                    .
                }
            }
        ],
        "setting": LO
            Other configuration
            . .
        }
    }
}
```

We have provided the Writer's plugin CnosDBWriter, and you can configure this plugin to import data from other sources into CnosDB via DataX.

## Plugin CnosDBWriter

The plugin cnosdbwriter is reading protocol data generated by the Reader plugin, generating a non-modeled writing statement sent to CnosDB.

- Data formats supported by OpenTSDB (via configuration format = "opentsdb").
- The maximum number of lines (via batchSize) and the maximum number of bytes (via configuration buffSize) are supported for each batchSize.
- Time accuracy (milliseconds, micro-seconds, nanos) is supported for configuring input data.

### Configure Parameters

| Configure Parameters | Description                                                                                                                                                                                        | Whether to select | Default value                         |
| -------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------- | ------------------------------------- |
| cnosdbWriteAPI       | CnosDB write API URL,string                                                                                                                                                                        | No                | `http:///127.0.0.1:8902/api/v1/write` |
| tenant               | tenant,string                                                                                                                                                                                      | No                | `cnosdb`                              |
| Database database    | Database,string                                                                                                                                                                                    | No                | `public`                              |
| username             | username,string                                                                                                                                                                                    | No                | `root`                                |
| password             | Password,string                                                                                                                                                                                    | No                | `root`                                |
| batchSize            | Maximum lines per batch, unsigned integer                                                                                                                                                          | No                | `1000`                                |
| BufferSize           | Maximum number of bytes per batch, unsigned integer                                                                                                                                                | No                | `8388608`                             |
| Format               | The format used by Reader and string;If Reader uses a special format (e.g. opentsdbreader), the configuration needs to be provided; optional values are `datax`, `opentsdb`.    | No                | `datax`                               |
| Table                | Table,string;No configuration required when format is `opentsdb`.                                                                                                                                  | Yes               | -                                     |
| Tags                 | Map type, Tag name and the serial number of the corresponding input column (unsigned integer from 0); only when the format is `datax`.The detailed format is described below.   | Yes               | *                                     |
| Field                | Map type, field name and the serial number of the corresponding input column (unsigned integer from 0); only when the format is `datax`.The detailed format is described below. | Yes               | -                                     |
| timeIndex            | The time field should enter the serial number of the column, unsigned integer from 0; only if the format is `datax`.                                                                               | Yes               | *                                     |
| Precision            | Enter the timestamp accuracy,string;optional values are `s`, `ms`,`us`,`ns` for seconds, milliseconds, microseconds and nanoss.                                                                    | No                | `ms`                                  |
| TagsExtra            | Map type, configure additional Tags, as additional columns of data per line, to be imported into CnosDB.The detailed format is described below.                                                    | No                | -                                     |
| FieldsExtra          | Map type, configuration data output from selected columns of reader to which tables and columns of CnosDB.Only take effect when format is `opentsdb`.The detailed format is described below.       | No                | *                                     |

Note：

- When the batchSize and bufferSzie conditions are met, the batchSize data are immediately sent to CnosDB, while clearing the buffer zone.For example, when batchSize=1000, BufferSize=1048566, if the number of lines in the buffer zone reaches 1,000, the data will be sent, even if it does not reach 1MB, and when the buffer reaches 1MB, it will be sent if the number of lines does not reach 1000 lines.

- The default value of the configuration format is `datax`. For CnosdbWriters to assume data format is a table type, so you need to manually set three configurations for table, tags, fields, timeIndex.

  - The configuration item table specifies the data output to one of the CnosDB tables.

  - Configuration tags specify which columns correspond to CnosDB tag column in table type data.Assuming Tag, Tag names are "host" and "unit" in the first or second of the tables, this can be set to：

    ```json
    "tags": LO
        "host": 1,
        "unit": 2
    }
    ```

  - Config fields specify which columns correspond to CnosDB field column in table type data.Assuming that the 3 and 4 components of the table,field names are "usage_min", "usage_max", then： can be set

    ```json
    "Fields": LO
        "usage_min": 3,
        "usage_max": 4
    }
    ```

  - The configuration item timeIndex specifies which columns correspond to CnosDB time column.Assuming item 0 of the table, this can be set to：

    ```json
    "timeIndex": 0
    ```

- Config specifies the time accuracy provided by the Reader plugin, default in milliseconds.CnosDB will convert time by default because CnosDBWRitter will be stored by default.

- The configuration item tagsExtra is formatted as `{ tag 名称: tag 值 }`, if a defined selected Tag already exists in the input data, it is ignored, and instead uses the Tag in the input data.The following example indicates the addition of `host=localhost` and `source=datax` two Tags： for each row

  ```json
  "host": "localhost", "source": "datax" }
  ```

- Foramt can also be set to `opentsdb`. For CnosDBWriter to assume that the input data has only one column and that the JSON format in OpenTSDB will write the request no longer need to configure table, tags, fields, timeIndex, which will be obtained from the OpenTSDB writing request in JSON format.

  - The configuration field Extra takes effect at this time, in the form of the `\s source column: {"table": target table, "field": target column } }`.以下示例表示将 OpenTSDB column `cpu_usage` 的数据写入 CnosDB 的表 `table` 的 数据列 `usage` 中：

    ```json
    - "cpu_usage": LO": "cpu", "field": "usage"}
    ```

### Type Conversion

For the purpose of regulating source and destination type conversion operations to ensure data is true, DataX converts the different types of Reader to internal types, see [DataX Documentation - Type Transformation] (https\://github.com/alibaba/DataX/blob/master/dataxPluginDev.md#Type).These internal types are below：

- `Long`：fixed points (Int, Short, Long, BigInteger, etc.).
- `Double`：floats (Float, Double, BigDecimal (unlimited precision), etc.).
- `String`：string type, base is unlimited and use a common charset (Unicode).
- `Date`：date type.
- `Bool`：boole.
- `Bytes`：binary to store unstructured data such as MP3.

CnosDBWriter will convert these internal types to an internal data type for CnosDB, following：

| DATAX Internal Type                       | CNOSDB data type                          |
| ----------------------------------------- | ----------------------------------------- |
| Date (time column)     | TIMESTAMP (NANOSECOND) |
| Date (not time column) | BIGINT                                    |
| Long                                      | BIGINT                                    |
| Double                                    | DOUBLE                                    |
| Bytes                                     | Not supported                             |
| String                                    | STRING                                    |
| Bool                                      | BOOLEN                                    |

## Example - Import CnosDB from OpenTSDB

### Precondition

- Install Python 2 or 3, JDK 1.8 and DataX, see [DataX Documentation - Quick Start] (https\://github.com/alibaba/DataX/blob/master/userGuid.md#quick-start).
- Install CnosDB, see section [部署](../employe).

我们假设 DataX 被安装到 `{YOUR_DATAX_HOME}` 路径下。

### Parameter Configuration

#### Reader Plugin OpenTSDBReader Configuration

Assume that we have a running OpenTSDB and are about to export the following：

- Node address：`http://127.0.0.1:4242`
- Indicator：`sys.cpu.nice`
- Start：`2023-06-01 00:00`
- End：`2023-06-02 00:00:00`
- Time Precision：ms

So, the configuration parameter for the Reader plugin OpenTSDBReader is the following：

```json
LO
    "name": "opentsdbreader",
    "parameter": LO
        "endpoint": "http://localhost:4242",
        "column": [
            "cpu_usage_nice",
            "cpu_usage_idle"
        ],
        "beginDateTime": "2023-06-01 00:00:",
        "endDateTime": "2023-06-02 00:00"
    }
}
```

Time accuracy is not written in OpenTSDBReader configuration, but needs to be provided to CnosDBWriter's configuration.

By default, column config will be used as table name for CnosDB.The `cpu_usage_nice` table and `cpu_usage_idle` tables will eventually be generated in CnosDB, and the indicator data will be written to the `value` column of both tables.By configuring fieldsExtra, `cpu_usage_nice` and `cpu_usage_idle` can be written to the same table as CnosDB, see below in the configuration for FieldsExtra.

Data content in OpenTSDB below：

```sh
curl 'http://localhost:4242/api/query? tart=2023/06/01-00:00&end=2023/06/01-01:00:00&m=none:cpu_usage_nice' |jq
[
    Fum
        "metric": "cpu_usage_nice",
        "tags": LO
            "host": "myhost",
            "cpu": "cpu0"
        },
        "aggregateTags": [],
        "dps": LOs
            "1685548810,000": 0. ,
            "1685548820000": 0. ,
            "1685548803000": 0. ,
            "1685548840000": 1. 09054,
            "16855488000": 4. 85149,
            "16855488600": 19. 58805,
            "16855488700": 27. 69705,
            "1685548800": 32. 13946,
            "16855488900": 37. 21445,
            "16855548900,000": 26. 37964,
        }
    }
]

curl 'http://localhost:4242/api/query? tart=2023/06/01-00:00&end=2023/06/01-01:00:00&m=none:cpu_usage_idle' |jq
[

        "metric": "cpu_usage_nice",
        "tags": LO
            "host": "myhost",
            "cpu": "cpu0"
        },
        "aggregateTags": [],
        "dps": LO
            "1685548810,000": 26. 37964,
            "1685548820000": 37. 21445,
            "1685548830,000 ": 32. 13946,
            "1685548840000": 27. 69705,
            "1685548000": 1. 09054,
            "16855488600": 19. 58805,
            "168554888700": 4. 85149,
            "16855488800": 0. ,
            "168554880000": 0. ,
            "1685548900,000": 0. ,
        }
    }
]
```

#### Writer Plugin CnosDBarrier Configuration

Assume that we have CnosDB running, parameters below：

- Interface address： `http://127.0.0.0.1:8902/api/v1/write`
- Tenant：`cnosdb`
- Database：`public`
- User：`root`
- Password：`root`

> In conjunction with OpenTSDBReader and CnosDBWriter, the CnosdbWriter's configuration format needs to be set to `opentsdb` and then CnosdbWriter to correctly write the data to CnosDB.

So the configuration parameters for the Writer's plugin CnosdbWriter, as follows:：

```json
{
    "name": "cnosdbwriter",
    "parameter": {
        "cnosdbWriteAPI": "http://127.0.0.1:8902/api/v1/write",
        "tenant": "cnosdb",
        "database": "public",
        "username": "root",
        "password": "root",
        "format": "opentsdb",
        "fieldsExtra": {
            "cpu_usage_nice": {
                "table": "cpu", "field": "usage_nice"
            },
            "cpu_usage_idle": {
                "table": "cpu", "field": "usage_idle"
            }
        }
    }
}
```

### Import started

1. 我们新建一个 DataX 配置文件，并且将前面的 OpenTSDBReader 和 CnosDBWriter 配置填充到 reader 和 writer 项中，保存为 `{YOUR_DATAX_HOME}/bin/opentsdb_to_cnosdb.json`：

```json
{
    "job": {
        "content": [
            {
                "reader": {
                    "name": "opentsdbreader",
                    "parameter": {
                        "endpoint": "http://localhost:4242",
                        "column": [
                            "cpu_usage_nice",
                            "cpu_usage_idle"
                        ],
                        "beginDateTime": "2023-06-01 00:00:00",
                        "endDateTime": "2023-06-02 00:00:00"
                    }
                },
                "writer": {
                    "name": "cnosdbwriter",
                    "parameter": {
                        "cnosdbWriteAPI": "http://127.0.0.1:8902/api/v1/write",
                        "tenant": "cnosdb",
                        "database": "public",
                        "username": "root",
                        "password": "root",
                        "format": "opentsdb",
                        "fieldsExtra": {
                            "cpu_usage_nice": {
                                "table": "cpu", "field": "usage_nice"
                            },
                            "cpu_usage_idle": {
                                "table": "cpu", "field": "usage_idle"
                            }
                        }
                    }
                }
            }
        ],
        "setting": {
            "speed": {
                "channel": 1
            }
        }
    }
}
```

2. Run datax.py, start import：

```sh
cd {YOUR_DATAX_HOME}/bin
python ./datax.py ./opentsdb_to_cnosdb.json
```

Final output below：

```txt
...
2023-07-01 12:34:56. 89 [job-0] INO JobContainer -
Task Start Moment : 2023-07-01 12:34:55
End Time of Quest: 2023-07-01 12:34:56
Total task time duration: 1s
Task average flow: 508B/s
Record write speed : 20rec/s
Total read and write: 20
Total failed read and writing: 0
```

Data in CnosDB is below：

```sql
SELECT * FROM cpu ORDER BY time ASC;
+---------------------+--------+------+------------+------------+
| time                | host   | cpu  | usage_nice | usage_idle |
+---------------------+--------+------+------------+------------+
| 2023-06-01T00:00:10 | myhost | cpu0 | 0.0        | 26.837964  |
| 2023-06-01T00:00:20 | myhost | cpu0 | 0.0        | 37.621445  |
| 2023-06-01T00:00:30 | myhost | cpu0 | 0.0        | 32.713946  |
| 2023-06-01T00:00:40 | myhost | cpu0 | 1.509054   | 27.269705  |
| 2023-06-01T00:00:50 | myhost | cpu0 | 4.885149   | 1.509054   |
| 2023-06-01T00:01:00 | myhost | cpu0 | 19.758805  | 19.758805  |
| 2023-06-01T00:01:10 | myhost | cpu0 | 27.269705  | 4.885149   |
| 2023-06-01T00:01:20 | myhost | cpu0 | 32.713946  | 0.0        |
| 2023-06-01T00:01:30 | myhost | cpu0 | 37.621445  | 0.0        |
| 2023-06-01T00:01:40 | myhost | cpu0 | 26.837964  | 0.0        |
+---------------------+--------+------+------------+------------+
```

### View import task status

DataX 的作业运行的日志文件默认位于 `{YOUR_DATAX_HOME}/log` 目录下。In these log files, we can view the startup, end time, state and any output and error messages.In addition, import progress： can be obtained by searching for export tables in CnosDB

```sql
SELECT COUNT(usage_idle) as c FROM "cpu";
+-----+
| c |
+---+
| 10 |
+--+
```

### Cancel or stop importing tasks

You can turn off the imported task by terminating the DataX process:

```sh
pkill datax
```
